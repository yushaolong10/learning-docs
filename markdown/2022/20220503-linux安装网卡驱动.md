[TOC]

### linux安装网卡驱动

#### 1.什么是驱动？
驱动是操作系统与硬件沟通的桥梁。操作系统定义了硬件接入的接口，驱动进行实现。

**应用程序读取网卡数据的流程大致如下:**

- 1.基于网卡硬件型号，安装相应驱动
- 2.驱动会向系统内核申请sk_buff空间，此空间位于驱动层，并将空间地址发送给网卡
- 3.网卡接受数据包之后，通过DMA写入到sk_buff空间，并触发硬中断
- 4.操作系统保存运行上下文，响应硬中断，并将信号写入软中断表
- 5.基于操作系统的时间片调度方式，内核发现软中断之后，将数据从驱动层sk_buff读入到内核空间
- 6.应用程序将数据从内核空间读入到用户空间

#### 2.命令概要
`lsusb`: 查询插入到usb接口的硬件设备型号

`lspci`: 查询pci总线上的硬件设备型号

`lsmod`: 查询已安装的驱动模块

`modprobe`: 安装驱动

`ifconfig ${card} up`: 激活网卡

`iwlist ${card} scan`: 扫描无线网络

`wpa_passphrase`: 设置网络密码

`wpa_supplicant`: 运行无线网络连接

`dhclient ${card}`: 分配ip

#### 3.安装步骤

> 本节介绍`rtl8188eu`芯片的驱动安装方式

##### 3.1 检测并调整本机时间

```bash
#检测本机时间是否正常
> date    
Tue May  3 00:34:41 CST 2022
#不正常,则进行校准
> date -s "2022/05/03 00:34:25"
#将当前系统时间写入到CMOS中
> clock -w
```

##### 3.2 查看系统是否识别wifi芯片

```bash
#将无线网卡插入USB接口
#查看系统是否识别芯片
> lsusb
Bus 002 Device 002: ID 0bda:8179 Realtek Semiconductor Corp. RTL8188EUS 802.11n Wireless Network Adapter
```

##### 3.3 编译并安装驱动

```bash
#github: https://github.com/lwfinger/rtl8188eu
#进行编译,安装
> make all
> make install
# 编译的时候若出现
make: *** /lib/modules/3.10.0-1160.45.1.el7.x86_64/build/: No such file or directory.  Stop.
#则将已有内核建立软连接
> ln -s /usr/src/kernels/3.10.0-1127.el7.x86_64  /lib/modules/3.10.0-1160.45.1.el7.x86_64/build/

#将编译生成的ko文件拷贝到内核路径，并在内核路径执行如下命令
#该命令会将驱动加载到modules.dep、modules.dep.bin等文件
> depmod -a
#系统载入驱动模块
> modprobe 8188eu
#查看驱动是否安装成功
> lsmod | grep 8188
```

##### 3.4 激活网卡

```bash
#查看网卡情况
> ifconfig -a
wlp0s29f7u1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.1.104  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::213:efff:fef8:414c  prefixlen 64  scopeid 0x20<link>
        ether 00:13:ef:f8:41:4c  txqueuelen 1000  (Ethernet)
        RX packets 90483  bytes 82632937 (78.8 MiB)
        RX errors 0  dropped 3011  overruns 0  frame 0
        TX packets 30298  bytes 7919663 (7.5 MiB)
        TX errors 0  dropped 79 overruns 0  carrier 0  collisions 0
#激活网卡
ifconfig wlp0s29f7u1 up
```

##### 3.5 设置网络热点

```bash
#扫描无线热点
#若能扫描成功,则说明网卡驱动正常
> iwlist wlp0s29f7u1 scan
#设置无线热点账号及密码
> wpa_passphrase ${wifi_ssid} > /etc/wpa_supplicant/wpa_supplicant.conf
      #stdin
      ${wifi_password}
#运行无线网络连接
> wpa_supplicant -D wext -B -i wlp0s29f7u1 -c /etc/wpa_supplicant/wpa_supplicant.conf 
ioctl[SIOCSIWAP]: Operation not permitted  出现这个没影响,实际已经连接成功
#分配动态ip
> dhclient wlp0s29f7u1
```

##### 3.6 加载网卡

```bash
#编辑 ifcfg-wlp0s29f7u1 文件
> vim /etc/sysconfig/network-scripts/ifcfg-wlp0s29f7u1
DEVICE=wlp0s29f7u1
BOOTPROTO=dhcp
ONBOOT=yes
ssid="${ssid}"
psk=${psk} #wpa_passphrase会生成
NAME=wlp0s29f7u1
WPA=yes
```

##### 3.7 开机自动加载

```bash
#可在rc.local配置如下命令,按需实现开机联网需求
#运行无线网络连接
> wpa_supplicant -D wext -B -i wlp0s29f7u1 -c /etc/wpa_supplicant/wpa_supplicant.conf 
ioctl[SIOCSIWAP]: Operation not permitted  出现这个没影响,实际已经连接成功
#分配动态ip
> dhclient wlp0s29f7u1
```

